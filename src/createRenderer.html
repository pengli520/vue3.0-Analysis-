<!--
 * @Author: your name
 * @Date: 2020-12-26 10:49:41
 * @LastEditTime: 2020-12-30 15:58:35
 * @LastEditors: Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: \vue-next\index1226.html
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script src="./packages/vue/dist/vue.global.js"></script> -->
    <script src="./reactive.js"></script>
    <title>Document</title>
</head>
<body>
    <div id="app">
        
    </div>
</body>
</html>
<script>
    const {log} = console
    const compile = {
        // dom转换虚拟dom
        domToVnode(dom) {
            // console.log({...[node]}, node.attributes, node.tagName, node.textContent, node.nodeType, node.childNodes)
            return {
                type: dom.tagName.toLocaleLowerCase(),
                props: this.filterProps(dom.attributes),
                children: this.nodeList(dom),
            }
        },
        nodeList(dom) {
            let obj = []
            Array.from(dom.childNodes).forEach(item => {
                if (item.nodeType === Node.TEXT_NODE) {
                    obj.push(item.textContent)
                } else {
                    obj.push({
                        type: item.tagName && item.tagName.toLocaleLowerCase() || null,
                        props: this.filterProps(item.attributes),
                        children: item.childNodes.length ? this.nodeList(item) : [item.textContent],
                    })
                }
            })
            return obj;
        },
        filterProps(NamedNodeMap) {
            let props = {};
            if (NamedNodeMap) {
                for (let item of NamedNodeMap) {
                    props[item.name] = item.value
                }
            }
            return props;
        },

        render(dom) {
            // 根据type类型来创建对应的元素
            let el = document.createElement(dom.type);

            // 再去遍历props属性对象，然后给创建的元素el设置属性
            for (let key in dom.props) {
                // 设置属性的方法
                el.setAttribute(key.replace('@', ''), dom.props[key]);
            }

            // 遍历子节点
            // // 如果子节点也是虚拟DOM，递归构建DOM节点
            // 不是就代表是文本节点，直接创建
            dom.children.forEach(child => {
                child = (child instanceof Element) || child.type ? this.render(child) : document.createTextNode(child);
                // 添加到对应元素内
                el.appendChild(child);
            });

            return el;
        },
        // 字符串转换成dom元素， div为默认根节点
        stringToDom(template) {
            return document.createRange().createContextualFragment(template).querySelector('div')
        }
    };

    // app实例创建
    const createAppAPI = (render) => {
        return function createApp(rootComponent, props) {
            const { template, render: curRender, data } = rootComponent
            const app = {
                // rootContainer：挂载容器
                mount(rootContainer){
                    let vnode
                    app.proxy = reactive(data())

                    effect(() => {
                        if (render) {
                            vnode = curRender.call(app.proxy)
                        } else {
                            // dom->vnode 在vue内部做了大量工作，此处简化
                            vnode = compile.domToVnode(compile.stringToDom(template)).call(app.proxy)
                        }                       
                        render(vnode, rootContainer)
                    })
                    return app.proxy
                }
            }
            return app
        }
    }

    // 自定义渲染器
    const createRenderer = (options) => {
        const { createElement, createText, setElementText, patchProp, insert, querySelector} = options
        const render = (vnode, rootContainer) => {
            // 更新节点，还是初始化
            const xxx = () => {
                if (rootContainer._vnode) {
                    // update
                    // patch
                } else {
                    // init
                    // patch()
                }
            }
            const parent = querySelector(rootContainer)
            parent.innerHTML = ''
            const recursive = (vnode) => {
                let el = createElement(vnode.type);
                for (let key in vnode.props) {
                    // 设置属性的方法
                    patchProp(el, key, null, vnode.props[key])
                }                
                vnode.children.forEach(child => {
                    child = child.type
                    ? recursive(child)
                    : createText(child);
                    // 添加到对应元素内
                    el.appendChild(child);
                })
                return el;
            }

            insert(recursive(vnode), parent)
        }
        return {
            render,
            createApp: createAppAPI(render)
        }
    }

    // dom相关的api操作
    const renderer = createRenderer({
        createElement(tag) {
            return tag ? document.createElement(tag) : document.createTextNode(tag || '')
        },
        createText(text) {
            return document.createTextNode(text)
        },
        insert(child, parent, anchor) {
            log(child, parent, anchor, 'insert')
            parent.insertBefore(child, anchor || null)
        },
        setElementText(el, text) {
            log(el, text, 'setElementText')
            el.textContent = text
        },
        patchProp(el, key, prevValue, nextValue) {
            log(el, key, prevValue, nextValue, 'patchProp')
            el[key] = nextValue
        },
        querySelector(sel) {
            return document.querySelector(sel)
        },
    })

    // 创建实列
    const vm = renderer.createApp({    
        template: '<div>我是h1标签{{msg}}<p>我是p<img src="https://mrkj-kjj-test.oss-cn-hangzhou.aliyuncs.com//UploadFiles/images/1608879770966151.jpg"/><div style="width:200px;height:300px;background:red"></div> </p>5555<h1>你好</h1></div>',
        data() {
            return {
                msg: '测试一波',
                p: '我是p标签'
            }
        },
        render() {
            return {
                type: 'div',
                props: {},
                children: [
                    this.msg,
                    {
                        type: 'p',
                        props: {},
                        children: [this.p]
                    },
                ]
            }
        }
    }).mount('#app')
    log(vm, '*--')
</script>